name: Build Checker
on:
  pull_request:
    branches: [main, development]
  push:
    branches: [main]
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  BuildCheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "yarn"

      - name: Install dependencies
        run: |
          yarn set version berry
          yarn install

      - name: Build Next.js app
        id: build_nextjs
        run: |
          BUILD_START_TIME=$(date +%s)
          echo "Build started at $(date)"

          # 빌드 실행 및 exit code 캡처
          set +e
          yarn build 2>&1 | tee build.log
          BUILD_EXIT_CODE=$?
          set -e

          BUILD_END_TIME=$(date +%s)
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          echo "Build finished at $(date)"

          # 환경변수 설정
          echo "BUILD_DURATION=$BUILD_DURATION" >> $GITHUB_ENV
          echo "BUILD_EXIT_CODE=$BUILD_EXIT_CODE" >> $GITHUB_ENV

          # 빌드 상태 텍스트 설정
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "BUILD_STATUS=✅ SUCCESS" >> $GITHUB_ENV
          else
            echo "BUILD_STATUS=❌ FAILED" >> $GITHUB_ENV
          fi

          # 로그 파일 확인 및 요약 생성
          if [ ! -f build.log ]; then
            echo "Build log not available" > build.log
          fi
          tail -n 45 build.log > build_summary.log
        env:
          NEXT_PUBLIC_API_BASE_URL: https://api-dev.kokomen.kr/api/v1
          NEXT_PUBLIC_BASE_URL: https://localhost:3000

      - name: Format build log and set output
        id: set_log
        if: github.event_name == 'pull_request'
        run: |
          # 환경변수를 사용하여 댓글 내용 생성
          {
            echo "COMMENT<<DELIMITER"
            echo "## 🛠️ Build Summary"
            echo ""
            echo "**Status:** $BUILD_STATUS"
            echo "**Duration:** ${BUILD_DURATION}초"
            echo "**Exit Code:** $BUILD_EXIT_CODE"
            echo "**Commit:** \`${GITHUB_SHA:0:7}\`"
            echo ""
            echo "### 📋 Build Output (마지막 45줄)"
            echo "\`\`\`"
            
            if [ -f build_summary.log ]; then
              cat build_summary.log
            else
              echo "No build output available"
            fi
            
            echo "\`\`\`"
            echo ""
            echo "_🤖 Generated by GitHub Actions at $(date)_"
            echo "DELIMITER"
          } >> $GITHUB_ENV

      - name: Post comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ env.COMMENT }}
          edit-mode: replace

      - name: Check build result
        run: |
          if [ "$BUILD_EXIT_CODE" -ne 0 ]; then
            echo "❌ Build failed with exit code $BUILD_EXIT_CODE"
            exit 1
          else
            echo "✅ Build succeeded"
          fi
