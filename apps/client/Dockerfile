FROM node:22-alpine AS builder

ENV NODE_ENV=production

WORKDIR /app

RUN corepack enable

COPY . .

ARG NEXT_PUBLIC_BASE_URL
ARG NEXT_PUBLIC_API_BASE_URL
ARG NEXT_PUBLIC_POSTHOG_KEY
ARG NEXT_PUBLIC_POSTHOG_HOST
ARG SENTRY_AUTH_TOKEN
ARG NEXT_PUBLIC_V2_API_BASE_URL
ARG NEXT_PUBLIC_NOTIFICATION_API_BASE_URL
ENV NEXT_PUBLIC_V2_API_BASE_URL=$NEXT_PUBLIC_V2_API_BASE_URL
ENV NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL
ENV NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL
ENV NEXT_PUBLIC_POSTHOG_KEY=$NEXT_PUBLIC_POSTHOG_KEY
ENV NEXT_PUBLIC_POSTHOG_HOST=$NEXT_PUBLIC_POSTHOG_HOST
ENV NEXT_PUBLIC_NOTIFICATION_API_BASE_URL=$NEXT_PUBLIC_NOTIFICATION_API_BASE_URL
ENV SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN

RUN yarn install

WORKDIR /app/apps/client

RUN yarn types:build

RUN yarn build

WORKDIR /app
CMD ["yarn", "client:prod"]